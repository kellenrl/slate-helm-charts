{{- if .Values.phpmyadmin.enabled -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: phpmyadmin
  name: {{ include "mysql-57.fullname" . }}-phpmyadmin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: phpmyadmin
  template:
    metadata:
      labels:
        app: phpmyadmin
    spec:
      containers:
      - image: phpmyadmin/phpmyadmin
        imagePullPolicy: Always
        name: {{ include "mysql-57.fullname" . }}-phpmyadmin
        ports:
        - containerPort: {{ .Values.phpmyadmin.apache2.port }}
        env:
          {{ if .Values.phpmyadmin.auto_login -}}
          - name: PMA_HOST
            value: {{ include "mysql-57.fullname" . }}
          - name: PMA_USER
            valueFrom:
              secretKeyRef:
                name: {{ include "mysql-57.fullname" . }}-auth
                key: username
          - name: PMA_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ include "mysql-57.fullname" . }}-auth
                key: password
          {{ else }}
          - name: PMA_HOST
            value: {{ include "mysql-57.fullname" . }}
          {{ end }}
        volumeMounts:
        - name: "phpmyadmin-apache2-config"
          mountPath: '/etc/apache2/sites-available/000-default.conf'
          subPath: '000-default.conf'
        - name: "phpmyadmin-apache2-config"
          mountPath: '/etc/apache2/ports.conf'
          subPath: 'ports.conf'
        - name: "phpmyadmin-blowfish"
          mountPath: '/etc/phpmyadmin/config.secret.inc.php'
          subPath: 'config.secret.inc.php'
        - name: "phpmyadmin-userconfig"
          mountPath: '/etc/phpmyadmin/config.user.inc.php'
          subPath: 'config.user.inc.php'
        - name: "tempdir"
          mountPath: '/var/www/html/tmp'
      volumes:
      - name: phpmyadmin-apache2-config
        configMap:
          name: phpmyadmin-apache2-config
          defaultMode: 0644
      - name: phpmyadmin-blowfish
        secret:
          secretName: phpmyadmin-blowfish
      - name: phpmyadmin-userconfig
        configMap:
          name: phpmyadmin-userconfig
          defaultMode: 0644
      - name: tempdir
        persistentVolumeClaim:
          claimName: {{ include "mysql-57.fullname" . }}-phpmyadmin-tempdir
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: phpmyadmin
  name: {{ include "mysql-57.fullname" . }}-phpmyadmin
spec:
  ports:
  - name: http
    port: {{ .Values.phpmyadmin.apache2.port }}
    protocol: TCP
    targetPort: {{ .Values.phpmyadmin.apache2.port }}
  selector:
    app: phpmyadmin
  type: ClusterIP
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: phpmyadmin-apache2-config
data:
  000-default.conf: |
    <VirtualHost *:{{ .Values.phpmyadmin.apache2.port }}>
        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
    </VirtualHost>
  ports.conf: |
    Listen {{ .Values.phpmyadmin.apache2.port }}
    <IfModule ssl_module>
      Listen 443
    </IfModule>
    <IfModule mod_gnutls.c>
      Listen 443
    </IfModule>
---
apiVersion: v1
kind: Secret
metadata:
  name: phpmyadmin-blowfish
data:
  {{ if .Values.phpmyadmin.blowfish_secret -}}
  config.secret.inc.php: {{ printf "<?php\n $cfg['blowfish_secret'] = '%s';\n ?>" .Values.phpmyadmin.blowfish_secret | b64enc }}
  {{ else }}
  config.secret.inc.php: {{ printf "<?php\n $cfg['blowfish_secret'] = '%s';\n ?>" (randAscii 32) | b64enc }}
  {{ end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: phpmyadmin-userconfig
data:
  config.user.inc.php: |
    {{ .Values.phpmyadmin.user_config }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "mysql-57.fullname" . }}-phpmyadmin-tempdir
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.phpmyadmin.tempdir_size }}
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: {{ include "mysql-57.fullname" . }}-phpmyadmin
spec:
{{- if .Values.phpmyadmin.route.hostname }}
  host: {{ .Values.phpmyadmin.route.hostname }}
{{- end }}
  tls:
    insecureEdgeTerminationPolicy: Redirect
    termination: edge
  to:
    kind: Service
    name: {{ include "mysql-57.fullname" . }}-phpmyadmin
{{- end }}
